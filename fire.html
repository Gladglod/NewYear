<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>2026æ–°å¹´çƒŸèŠ±è´ºå¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        
        #theme-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }
        
        #moon-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 240px; /* å¢å¤§åˆ°åŸæ¥çš„4å€ */
            height: 240px;
            cursor: pointer;
            z-index: 10;
        }
        
        #blessing-text {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            padding: 0 20px;
            opacity: 0;
            transition: opacity 1s;
            z-index: 10;
        }
        
        #personalization-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            display: none;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #name-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }
        
        #submit-name {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        
        .effect-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        #special-effects {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none;
        }
        
        #special-effects button {
            margin-left: 10px;
        }
        
        @media (max-width: 768px) {
            #theme-indicator {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            #moon-container {
                width: 180px; /* ç§»åŠ¨ç«¯é€‚å½“å‡å° */
                height: 180px;
            }
            
            .effect-btn {
                font-size: 10px;
                padding: 6px 8px;
            }
            
            #blessing-text {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            #moon-container {
                width: 120px; /* å°å±å¹•è¿›ä¸€æ­¥å‡å° */
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>
    
    <!-- UIå…ƒç´  -->
    <div id="theme-indicator">ä¸»é¢˜: ç»å…¸</div>
    <div id="moon-container" title="ç‚¹å‡»æœˆäº®è·å–ç¥ç¦"></div>
    <div id="blessing-text"></div>
    <div id="special-effects">
        <button class="effect-btn" id="reverse-gravity">åé‡åŠ›</button>
        <button class="effect-btn" id="lucky-number">å¹¸è¿æ•°</button>
    </div>
    
    <!-- ä¸ªæ€§åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="personalization-modal">
        <h2>ğŸ† ä¸ªæ€§åŒ–è®¾ç½®</h2>
        <input type="text" id="name-input" placeholder="è¯·è¾“å…¥æ‚¨çš„åå­—" maxlength="10" autocomplete="off">
        <button id="submit-name">å¼€å¯ä¸“å±çƒŸèŠ±</button>
    </div>
    
    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>
    
    <!-- éšè—çš„ç¥ç¦è¯­ï¼Œç”¨äºæ–‡å­—çƒŸèŠ± -->
    <div class="hidden">
        <div class="shape">æ–°å¹´å¿«ä¹</div>
        <div class="shape">åˆå®¶å¹¸ç¦</div>
        <div class="shape">ä¸‡äº‹å¦‚æ„</div>
        <div class="shape">å¿ƒæƒ³äº‹æˆ</div>
        <div class="shape">è´¢æºå¹¿è¿›</div>
    </div>

    <script>
        // ================== è®¾å¤‡é€‚é… ==================
        const canvas = document.getElementById("fireworks-canvas");
        const ctx = canvas.getContext("2d");
        const DPR = window.devicePixelRatio || 1;
        
        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            canvas.width = w * DPR;
            canvas.height = h * DPR;
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        }
        
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
        
        // ================== å…¬å…±å˜é‡ ==================
        const shapes = document.querySelectorAll(".shape");
        const bigbooms = [];
        const stars = [];
        const raf = requestAnimationFrame;
        const rand = (a, b) => Math.random() * (b - a) + a;
        
        // ä¸»é¢˜å®šä¹‰
        const themes = [
            { name: 'ç»å…¸', colors: ['#ff3366', '#ff6633', '#ffcc33', '#33ff66', '#33ccff'] },
            { name: 'é‡‘è‰²', colors: ['#ffd700', '#ffaa00', '#ff7700', '#ff5500', '#ff3300'] },
            { name: 'éœ“è™¹', colors: ['#ff00ff', '#00ffff', '#ffff00', '#ff00aa', '#aa00ff'] },
            { name: 'å†°è“', colors: ['#00ffff', '#00aaff', '#0066ff', '#00ffaa', '#00ffcc'] },
            { name: 'é¸¿è¿', colors: ['#ff0000', '#ff3300', '#ff6600', '#ff9900', '#ffcc00'] }
        ];
        
        // ç¥ç¦è¯­åº“
        const blessings = [
            "æ–°å¹´å¿«ä¹ï¼Œä¸‡äº‹å¦‚æ„ï¼",
            "åˆå®¶å¹¸ç¦ï¼Œå®‰åº·ç¾æ»¡ï¼", 
            "å¿ƒæƒ³äº‹æˆï¼Œæ¢¦æƒ³æˆçœŸï¼",
            "è´¢æºå¹¿è¿›ï¼Œæ­¥æ­¥é«˜å‡ï¼",
            "èº«ä½“å¥åº·ï¼Œç¬‘å£å¸¸å¼€ï¼",
            "äº‹ä¸šæœ‰æˆï¼Œå‰ç¨‹ä¼¼é”¦ï¼",
            "å­¦ä¸šè¿›æ­¥ï¼Œé‡‘æ¦œé¢˜åï¼",
            "ç¦æ˜Ÿé«˜ç…§ï¼Œå¥½è¿è¿è¿ï¼"
        ];
        
        // åº”ç”¨çŠ¶æ€
        let themeIndex = 0;
        let themeTimer = null;
        let clickCount = 0;
        let lastClickTime = 0;
        let touchCount = 0;
        let lastTouchTime = 0;
        let personalizationUnlocked = false;
        let userName = '';
        let reverseGravityEnabled = false;
        let keyInput = '';
        let lastFireworkTime = 0;
        let activeTextFireworks = 0;
        const MAX_TEXT_FIREWORKS = 1; // é™åˆ¶åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ–‡å­—çƒŸèŠ±
        const textCache = new Map(); // æ–‡å­—ç²’å­ç¼“å­˜
        
        // ================== æœˆäº®åŠ è½½ ==================
        const moonCanvas = document.createElement("canvas");
        const moonCtx = moonCanvas.getContext("2d");
        moonCanvas.width = 480; // å¢å¤§å°ºå¯¸ä»¥é€‚åº”4å€æ”¾å¤§
        moonCanvas.height = 480;
        
        // åŠ è½½å¤–éƒ¨æœˆäº®å›¾ç‰‡
        const moonImage = new Image();
        moonImage.onload = function() {
            // ç»˜åˆ¶æœˆäº®ä¸»ä½“
            moonCtx.clearRect(0, 0, 480, 480);
            moonCtx.drawImage(moonImage, 120, 120, 240, 240); // è°ƒæ•´ç»˜åˆ¶ä½ç½®å’Œå¤§å°
            
            // æ·»åŠ æ·¡é»„è‰²å…‰æ™•
            const gradient = moonCtx.createRadialGradient(
                240, 240, 120,  // å†…åœ†ä½ç½®å’ŒåŠå¾„
                240, 240, 240   // å¤–åœ†ä½ç½®å’ŒåŠå¾„
            );
            gradient.addColorStop(0, "rgba(255,245,200,0.08)");
            gradient.addColorStop(0.5, "rgba(255,245,200,0.04)");
            gradient.addColorStop(1, "rgba(255,245,200,0)");
            
            moonCtx.fillStyle = gradient;
            moonCtx.beginPath();
            moonCtx.arc(240, 240, 240, 0, Math.PI * 2);
            moonCtx.fill();
            
            updateMoonPosition();
        };
        
        // è®¾ç½®å›¾ç‰‡æºï¼Œå¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        moonImage.onerror = function() {
            // åˆ›å»ºå¤‡ç”¨æœˆäº®
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 240;
            tempCanvas.height = 240;
            
            tempCtx.fillStyle = '#f5f3ce';
            tempCtx.beginPath();
            tempCtx.arc(120, 120, 100, 0, Math.PI * 2);
            tempCtx.fill();
            
            // é‡æ–°ç»˜åˆ¶åˆ°æœˆäº®ç”»å¸ƒ
            moonCtx.clearRect(0, 0, 480, 480);
            moonCtx.drawImage(tempCanvas, 120, 120, 240, 240);
            
            // æ·»åŠ å…‰æ™•
            const gradient = moonCtx.createRadialGradient(240, 240, 120, 240, 240, 240);
            gradient.addColorStop(0, "rgba(255,245,200,0.08)");
            gradient.addColorStop(0.5, "rgba(255,245,200,0.04)");
            gradient.addColorStop(1, "rgba(255,245,200,0)");
            
            moonCtx.fillStyle = gradient;
            moonCtx.beginPath();
            moonCtx.arc(240, 240, 240, 0, Math.PI * 2);
            moonCtx.fill();
            
            updateMoonPosition();
        };
        
        // åŠ è½½å›¾ç‰‡
        moonImage.src = "img/moon.png";
        
        // ================== æ›´æ–°æœˆäº®ä½ç½® ==================
        function updateMoonPosition() {
            const moonContainer = document.getElementById('moon-container');
            if (!moonContainer) return;
            
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // æ ¹æ®æ—¶é—´è®¡ç®—æœˆäº®ä½ç½®
            const totalMinutes = hours * 60 + minutes;
            const hourPercent = totalMinutes / (24 * 60);
            
            // æ°´å¹³ä½ç½®ï¼šä»å³ä¾§ç§»åŠ¨åˆ°å³ä¾§åä¸­
            const x = window.innerWidth - 260; // è°ƒæ•´ä½ç½®é€‚åº”æ›´å¤§çš„æœˆäº®
            
            // å‚ç›´ä½ç½®ï¼šæ­£å¼¦æ³¢è½¨è¿¹ï¼Œè°ƒæ•´å‚æ•°ä½¿å…¶æ›´é ä¸‹
            const y = 100 + Math.sin(hourPercent * Math.PI * 2) * 150;
            
            moonContainer.style.left = `${x}px`;
            moonContainer.style.top = `${y}px`;
        }
        
        // ================== æ˜Ÿæ˜Ÿ ==================
        class Star {
            constructor() {
                this.x = Math.random() * window.innerWidth;
                this.y = Math.random() * window.innerHeight;
                this.r = Math.random() * 1.2; // å°æ˜Ÿæ˜Ÿ
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.fill();
            }
        }
        
        // åˆ›å»ºæ˜Ÿæ˜Ÿ
        for (let i = 0; i < 120; i++) stars.push(new Star());
        
        // ================== çƒŸèŠ±ç±» ==================
        class Boom {
            constructor(tx, ty, shape = null) {
                this.x = rand(window.innerWidth * 0.3, window.innerWidth * 0.7);
                this.y = window.innerHeight;
                this.tx = tx;
                this.ty = ty;
                this.dead = false;
                this.frags = [];
                this.shape = shape;
                this.color = this.getRandomColor();
                this.trail = []; // è½¨è¿¹ç‚¹æ•°ç»„
                this.trailLength = 8; // è½¨è¿¹é•¿åº¦
            }
            
            getRandomColor() {
                const theme = themes[themeIndex];
                return theme.colors[Math.floor(Math.random() * theme.colors.length)];
            }
            
            move() {
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                this.x += dx * 0.05;
                this.y += dy * 0.05;
                
                // æ·»åŠ å½“å‰ç‚¹åˆ°è½¨è¿¹
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                // ç»˜åˆ¶è½¨è¿¹ - ä¼˜åŒ–ä¸ºæ¸å˜æ•ˆæœ
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${0.2 + alpha * 0.3})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                // ç»˜åˆ¶çƒŸèŠ±å¤´
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = "#fff";
                ctx.fill();
                
                // åˆ°è¾¾ç›®æ ‡ä½ç½®åçˆ†ç‚¸
                if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                    this.explode();
                    this.dead = true;
                }
            }
            
            explode() {
                if (this.shape) {
                    this.createTextBoom();
                    return;
                }
                
                const num = Math.floor(rand(80, 150));
                for (let i = 0; i < num; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = rand(20, 160);
                    this.frags.push(
                        new Frag(
                            this.x, this.y,
                            this.x + Math.cos(angle) * r,
                            this.y + Math.sin(angle) * r,
                            this.color
                        )
                    );
                }
                
                // 30%å‡ ç‡äºŒæ¬¡çˆ†ç‚¸
                if (Math.random() > 0.7) {
                    setTimeout(() => {
                        bigbooms.push(
                            new Boom(
                                this.x + rand(-120, 120),
                                this.y + rand(-100, 100)
                            )
                        );
                    }, 300);
                }
            }
            
            createTextBoom() {
                // å¦‚æœå·²ç»æœ‰æ–‡å­—çƒŸèŠ±ï¼Œåˆ›å»ºæ™®é€šçƒŸèŠ±ä»£æ›¿
                if (activeTextFireworks >= MAX_TEXT_FIREWORKS) {
                    this.createNormalBoom();
                    return;
                }
                
                activeTextFireworks++;
                const text = this.shape.textContent;
                const particles = this.getCachedTextParticles(text, this.color);
                
                // é™åˆ¶ç²’å­æ•°é‡ï¼Œé¿å…å¡é¡¿
                const maxParticles = Math.min(particles.length, 150);
                for (let i = 0; i < maxParticles; i++) {
                    const p = particles[i];
                    this.frags.push(new Frag(
                        this.x, this.y,
                        this.x + p.dx,
                        this.y + p.dy,
                        this.color
                    ));
                }
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨çƒŸèŠ±ç»“æŸåå‡å°‘è®¡æ•°
                setTimeout(() => {
                    activeTextFireworks--;
                }, 3000);
            }
            
            createNormalBoom() {
                const num = Math.floor(rand(80, 150));
                for (let i = 0; i < num; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = rand(20, 160);
                    this.frags.push(
                        new Frag(
                            this.x, this.y,
                            this.x + Math.cos(angle) * r,
                            this.y + Math.sin(angle) * r,
                            this.color
                        )
                    );
                }
            }
            
            getCachedTextParticles(text, color) {
                const cacheKey = `${text}-${color}`;
                if (textCache.has(cacheKey)) {
                    return textCache.get(cacheKey);
                }
                
                // åˆ›å»ºç¦»å±Canvasè¿›è¡Œé¢„æ¸²æŸ“
                const offCanvas = document.createElement("canvas");
                offCanvas.width = 300; // ä½¿ç”¨æ›´å°çš„ç¦»å±ç”»å¸ƒå‡å°‘è®¡ç®—é‡
                offCanvas.height = 150;
                const offCtx = offCanvas.getContext("2d");
                
                // ä½¿ç”¨åˆé€‚çš„å­—ä½“å¤§å°
                offCtx.font = "bold 80px 'Microsoft YaHei'";
                offCtx.textAlign = "center";
                offCtx.textBaseline = "middle";
                offCtx.fillStyle = "#fff";
                offCtx.fillText(text, offCanvas.width / 2, offCanvas.height / 2);
                
                const imgData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                const particles = [];
                
                // å¢åŠ é‡‡æ ·é—´éš”ï¼Œä»6pxå¢åŠ åˆ°10pxï¼Œå‡å°‘ç²’å­æ•°é‡
                for (let x = 0; x < imgData.width; x += 10) {
                    for (let y = 0; y < imgData.height; y += 10) {
                        const i = (y * imgData.width + x) * 4;
                        if (imgData.data[i + 3] > 150) {
                            particles.push({
                                dx: (x - offCanvas.width/2) * 1.2,
                                dy: (y - offCanvas.height/2) * 1.2
                            });
                        }
                    }
                }
                
                // ç¼“å­˜ç»“æœ
                textCache.set(cacheKey, particles);
                return particles;
            }
        }
        
        // ================== ç¢ç‰‡ç±» ==================
        class Frag {
            constructor(x, y, tx, ty, color) {
                this.x = x;
                this.y = y;
                this.tx = tx;
                this.ty = ty;
                this.vy = 0;
                this.dead = false;
                this.color = color;
                this.trail = []; // ç¢ç‰‡è½¨è¿¹
                this.trailLength = 5;
            }
            
            move() {
                this.vy += 0.18;
                this.ty += this.vy;
                
                this.x += (this.tx - this.x) * 0.08;
                this.y += (this.ty - this.y) * 0.08;
                
                // æ·»åŠ è½¨è¿¹ç‚¹
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                // ç»˜åˆ¶è½¨è¿¹
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length * 0.5;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 1;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                // ç»˜åˆ¶ç¢ç‰‡
                ctx.beginPath();
                ctx.arc(this.x, this.y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                if (this.y > window.innerHeight) this.dead = true;
            }
        }
        
        // ================== åŠ¨ç”»å¾ªç¯ ==================
        function animate(t) {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = "rgba(0,5,24,0.2)";
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
            
            // ç»˜åˆ¶æ˜Ÿæ˜Ÿ
            stars.forEach(s => s.draw());
            
            // ç»˜åˆ¶æœˆäº®
            const moonContainer = document.getElementById('moon-container');
            if (moonCanvas && moonContainer) {
                const x = parseInt(moonContainer.style.left) || window.innerWidth - 260;
                const y = parseInt(moonContainer.style.top) || 100;
                ctx.drawImage(moonCanvas, x, y, 240, 240); // ä½¿ç”¨æ–°å°ºå¯¸
            }
            
            // å®šæ—¶å‘å°„çƒŸèŠ±
            if (t - lastFireworkTime > 800) {
                if (Math.random() > 0.3) {
                    bigbooms.push(
                        new Boom(
                            rand(120, window.innerWidth - 120),
                            rand(120, window.innerHeight * 0.4)
                        )
                    );
                } else {
                    bigbooms.push(
                        new Boom(
                            window.innerWidth / 2,
                            window.innerHeight * 0.35,
                            shapes[Math.floor(Math.random() * shapes.length)]
                        )
                    );
                }
                lastFireworkTime = t;
            }
            
            // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
            for (let i = bigbooms.length - 1; i >= 0; i--) {
                const b = bigbooms[i];
                if (!b.dead) {
                    b.move();
                } else {
                    // æ‰¹é‡æ›´æ–°ç¢ç‰‡ï¼Œæé«˜æ€§èƒ½
                    for (let j = b.frags.length - 1; j >= 0; j--) {
                        const f = b.frags[j];
                        f.move();
                        if (f.dead) {
                            b.frags.splice(j, 1);
                        }
                    }
                    
                    if (b.frags.length === 0) {
                        bigbooms.splice(i, 1);
                    }
                }
            }
            
            raf(animate);
        }
        
        // ================== ä¸»é¢˜åŠŸèƒ½ ==================
        function startThemeRotation() {
            if (themeTimer) clearInterval(themeTimer);
            themeTimer = setInterval(() => {
                themeIndex = (themeIndex + 1) % themes.length;
                applyTheme(themes[themeIndex]);
            }, 10000);
        }
        
        function applyTheme(theme) {
            document.getElementById('theme-indicator').textContent = `ä¸»é¢˜: ${theme.name}`;
        }
        
        function switchTheme(index) {
            themeIndex = index;
            applyTheme(themes[themeIndex]);
        }
        
        // ================== äº‹ä»¶ç›‘å¬ ==================
        function setupEventListeners() {
            // ç‚¹å‡»äº‹ä»¶
            canvas.addEventListener("click", function(e) {
                const currentTime = Date.now();
                
                // æ£€æŸ¥è¿ç»­ç‚¹å‡»
                if (currentTime - lastClickTime < 500) {
                    clickCount++;
                } else {
                    clickCount = 1;
                }
                lastClickTime = currentTime;
                
                // è¿ç»­ä¸‰æ¬¡ç‚¹å‡»è§¦å‘ä¸ªæ€§åŒ–
                if (clickCount >= 3 && !personalizationUnlocked) {
                    document.getElementById('personalization-modal').style.display = 'block';
                    clickCount = 0;
                }
                
                // å‘å°„çƒŸèŠ±
                bigbooms.push(new Boom(e.clientX, e.clientY));
            });
            
            // è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener("touchstart", function(e) {
                e.preventDefault();
                const currentTime = Date.now();
                
                if (currentTime - lastTouchTime < 1000) {
                    touchCount++;
                } else {
                    touchCount = 1;
                }
                lastTouchTime = currentTime;
                
                // è¿ç»­10æ¬¡è§¦æ‘¸è§£é”éœ“è™¹ä¸»é¢˜
                if (touchCount >= 10) {
                    switchTheme(2);
                    showToast('è¿ç»­è§¦æ‘¸10æ¬¡ï¼Œè§£é”éœ“è™¹ä¸»é¢˜ï¼');
                    touchCount = 0;
                }
                
                if (e.touches.length > 0) {
                    bigbooms.push(new Boom(e.touches[0].clientX, e.touches[0].clientY));
                }
            }, { passive: false });
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener("keydown", function(e) {
                keyInput += e.key;
                
                if (keyInput.includes('2026')) {
                    switchTheme(4);
                    showToast('è¾“å…¥2026ï¼Œè§£é”é¸¿è¿ä¸»é¢˜ï¼');
                    keyInput = '';
                }
                
                if (keyInput.length > 10) {
                    keyInput = keyInput.slice(-10);
                }
            });
            
            // æœˆäº®ç‚¹å‡»äº‹ä»¶
            document.getElementById('moon-container').addEventListener('click', showMoonBlessing);
            
            // ä¸ªæ€§åŒ–åŠŸèƒ½
            document.getElementById('submit-name').addEventListener('click', saveUserName);
            document.getElementById('reverse-gravity').addEventListener('click', toggleReverseGravity);
            document.getElementById('lucky-number').addEventListener('click', showLuckyNumber);
            
            // æ‰‹åŠ¿äº‹ä»¶
            setupGestureEvents();
        }
        
        // ================== ç¥ç¦è¯­åŠŸèƒ½ ==================
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const blessParam = urlParams.get('bless');
            
            if (blessParam) {
                showBlessing(decodeURIComponent(blessParam));
            }
        }
        
        function showBlessing(text) {
            const blessingElement = document.getElementById('blessing-text');
            blessingElement.textContent = text;
            blessingElement.style.opacity = '1';
            
            setTimeout(() => {
                blessingElement.style.opacity = '0';
            }, 5000);
        }
        
        function showMoonBlessing() {
            const randomBlessing = blessings[Math.floor(Math.random() * blessings.length)];
            showBlessing(randomBlessing);
            showToast('ğŸŒ™ ç¥ä½ ï¼š' + randomBlessing);
        }
        
        // ================== ä¸ªæ€§åŒ–åŠŸèƒ½ ==================
        function saveUserName() {
            const nameInput = document.getElementById('name-input');
            userName = nameInput.value.trim();
            
            if (userName) {
                personalizationUnlocked = true;
                document.getElementById('personalization-modal').style.display = 'none';
                document.getElementById('special-effects').style.display = 'block';
                showToast(`ğŸ‰ æ¬¢è¿ ${userName}ï¼Œä¸ªæ€§åŒ–åŠŸèƒ½å·²è§£é”ï¼`);
                
                // åˆ›å»ºä¸“å±æ–‡å­—çƒŸèŠ±
                createPersonalizedFirework();
            } else {
                showToast('è¯·è¾“å…¥æ‚¨çš„åå­—');
            }
        }
        
        function createPersonalizedFirework() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;
            
            // åˆ›å»ºåå­—çƒŸèŠ±
            setTimeout(() => {
                const nameBoom = new Boom(centerX, centerY);
                nameBoom.explode = function() {
                    const particles = this.getCachedTextParticles(userName, '#ffd700');
                    
                    // é™åˆ¶ç²’å­æ•°é‡
                    const maxParticles = Math.min(particles.length, 150);
                    for (let i = 0; i < maxParticles; i++) {
                        const p = particles[i];
                        this.frags.push(new Frag(
                            this.x, this.y,
                            this.x + p.dx,
                            this.y + p.dy,
                            '#ffd700'
                        ));
                    }
                };
                bigbooms.push(nameBoom);
            }, 1000);
        }
        
        function toggleReverseGravity() {
            reverseGravityEnabled = !reverseGravityEnabled;
            
            // ä¿®æ”¹ç¢ç‰‡é‡åŠ›
            Frag.prototype.move = function() {
                if (reverseGravityEnabled) {
                    this.vy -= 0.18; // åé‡åŠ›
                } else {
                    this.vy += 0.18; // æ­£å¸¸é‡åŠ›
                }
                this.ty += this.vy;
                
                this.x += (this.tx - this.x) * 0.08;
                this.y += (this.ty - this.y) * 0.08;
                
                // æ·»åŠ è½¨è¿¹ç‚¹
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                // ç»˜åˆ¶è½¨è¿¹
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length * 0.5;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 1;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                if (reverseGravityEnabled) {
                    if (this.y < 0) this.dead = true;
                } else {
                    if (this.y > window.innerHeight) this.dead = true;
                }
            };
            
            showToast(reverseGravityEnabled ? 'ğŸˆ åé‡åŠ›çƒŸèŠ±å·²å¼€å¯' : 'â¬‡ï¸ æ¢å¤æ­£å¸¸é‡åŠ›');
        }
        
        function showLuckyNumber() {
            const luckyNumber = Math.floor(Math.random() * 100) + 1;
            showToast(`ğŸ° ${userName}çš„å¹¸è¿æ•°å­—æ˜¯ï¼š${luckyNumber}`);
            
            // ç”¨å¹¸è¿æ•°å­—åˆ›å»ºçƒŸèŠ±
            const numberBoom = new Boom(window.innerWidth / 2, window.innerHeight / 2);
            numberBoom.explode = function() {
                for (let i = 0; i < luckyNumber; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 100 + 50;
                    
                    this.frags.push(new Frag(
                        this.x, this.y,
                        this.x + Math.cos(angle) * distance,
                        this.y + Math.sin(angle) * distance,
                        '#00ff00'
                    ));
                }
            };
            bigbooms.push(numberBoom);
        }
        
        // ================== æ‰‹åŠ¿äº‹ä»¶ ==================
        function setupGestureEvents() {
            // åŒæŒ‡ç‚¹å‡»åˆ‡æ¢ä¸»é¢˜
            canvas.addEventListener('touchend', (e) => {
                if (e.touches.length === 0) {
                    const now = Date.now();
                    if (now - lastTouchTime < 300) {
                        switchTheme((themeIndex + 1) % themes.length);
                    }
                }
            });
            
            // ä¸‰æŒ‡ç‚¹å‡»æ˜¾ç¤ºéšæœºç¥ç¦
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 3) {
                    const randomBlessing = blessings[Math.floor(Math.random() * blessings.length)];
                    showBlessing(randomBlessing);
                    showToast('ä¸‰æŒ‡æ‰‹åŠ¿ï¼š' + randomBlessing);
                }
            });
        }
        
        // ================== æ—¶é—´æ£€æŸ¥ ==================
        function checkMidnight() {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() < 1) {
                switchTheme(1); // é‡‘è‰²ä¸»é¢˜
                showToast('ğŸ† å‡Œæ™¨0ç‚¹ï¼Œè‡ªåŠ¨å¯ç”¨é‡‘è‰²ä¸»é¢˜ï¼');
            }
        }
        
        // ================== å·¥å…·å‡½æ•° ==================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // ================== åˆå§‹åŒ– ==================
        function init() {
            setupEventListeners();
            parseURLParams();
            checkMidnight();
            startThemeRotation();
            raf(animate);
        }
        
        // å¯åŠ¨åº”ç”¨
        window.addEventListener('load', init);
    </script>
</body>
</html>