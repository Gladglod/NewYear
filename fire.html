<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>2026æ–°å¹´å¿«ä¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        
        #theme-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }
        
        #moon-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 240px;
            height: 240px;
            cursor: pointer;
            z-index: 10;
        }
        
        #blessing-text {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            padding: 0 20px;
            opacity: 0;
            transition: opacity 1s;
            z-index: 10;
        }
        
        #personalization-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 320px;
            display: none;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.8);
            -webkit-overflow-scrolling: touch;
            overflow: auto;
            max-height: 80vh;
        }
        
        #personalization-modal h2 {
            margin-bottom: 15px;
            text-align: center;
            color: #ffd700;
            font-size: 20px;
            padding: 0 10px;
        }
        
        #name-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        #submit-name {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
        }
        
        .effect-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .toast {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        .hidden {
            display: none;
        }
        
        #special-effects {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: none;
        }
        
        #special-effects button {
            margin-left: 10px;
        }
        
        #swipe-hint {
            position: absolute;
            bottom: 80px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
            padding: 0 20px;
            z-index: 10;
            display: none;
            animation: fadeInOut 2s infinite;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.3; }
        }
        
        @media (max-width: 768px) {
            #theme-indicator {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            #moon-container {
                width: 180px;
                height: 180px;
            }
            
            .effect-btn {
                font-size: 10px;
                padding: 6px 8px;
            }
            
            #blessing-text {
                font-size: 20px;
            }
            
            #swipe-hint {
                display: block;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            #moon-container {
                width: 120px;
                height: 120px;
            }
            
            #swipe-hint {
                font-size: 12px;
                bottom: 60px;
            }
        }
        
        @media (hover: hover) and (pointer: fine) {
            #swipe-hint {
                display: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>
    
    <div id="theme-indicator">ä¸»é¢˜: ç»å…¸</div>
    <div id="moon-container" title="ç‚¹å‡»æœˆäº®è·å–ç¥ç¦"></div>
    <div id="blessing-text"></div>
    <div id="special-effects">
        <button class="effect-btn" id="reverse-gravity">åé‡åŠ›</button>
        <button class="effect-btn" id="lucky-number">å¹¸è¿æ•°</button>
    </div>
    
    <div id="personalization-modal">
        <h2>ğŸ† ä¸ªæ€§åŒ–è®¾ç½®</h2>
        <input type="text" id="name-input" placeholder="è¯·è¾“å…¥æ‚¨çš„åå­—" maxlength="10" autocomplete="off">
        <button id="submit-name">å¼€å¯ä¸“å±çƒŸèŠ±</button>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <div class="hidden">
        <div class="shape">æ–°å¹´å¿«ä¹</div>
        <div class="shape">åˆå®¶å¹¸ç¦</div>
        <div class="shape">ä¸‡äº‹å¦‚æ„</div>
        <div class="shape">å¿ƒæƒ³äº‹æˆ</div>
        <div class="shape">è´¢æºå¹¿è¿›</div>
    </div>

    <script>
        const currentYear = new Date().getFullYear();

        // åˆ¤æ–­å½“å‰å¹´ä»½æ˜¯å¦ä¸º2026ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„æ ‡é¢˜
        if (currentYear === 2026) {
        document.title = "æ¬¢è¿æ¥åˆ°2026å¹´ï¼";
        } else {
        document.title = "2025å³å°†ç»“æŸï¼";
        }
        const canvas = document.getElementById("fireworks-canvas");
        const ctx = canvas.getContext("2d");
        const DPR = window.devicePixelRatio || 1;
        
        function resizeCanvas() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            canvas.style.width = w + "px";
            canvas.style.height = h + "px";
            canvas.width = w * DPR;
            canvas.height = h * DPR;
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        }
        
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
        
        const shapes = document.querySelectorAll(".shape");
        const bigbooms = [];
        const stars = [];
        const raf = requestAnimationFrame;
        const rand = (a, b) => Math.random() * (b - a) + a;
        
        const themes = [
            { name: 'ç»å…¸', colors: ['#ff3366', '#ff6633', '#ffcc33', '#33ff66', '#33ccff'] },
            { name: 'é‡‘è‰²', colors: ['#ffd700', '#ffaa00', '#ff7700', '#ff5500', '#ff3300'] },
            { name: 'éœ“è™¹', colors: ['#ff00ff', '#00ffff', '#ffff00', '#ff00aa', '#aa00ff'] },
            { name: 'å†°è“', colors: ['#00ffff', '#00aaff', '#0066ff', '#00ffaa', '#00ffcc'] },
            { name: 'é¸¿è¿', colors: ['#ff0000', '#ff3300', '#ff6600', '#ff9900', '#ffcc00'] }
        ];
        
        const blessings = [
            "æ–°å¹´å¿«ä¹ï¼Œä¸‡äº‹å¦‚æ„ï¼",
            "åˆå®¶å¹¸ç¦ï¼Œå®‰åº·ç¾æ»¡ï¼", 
            "å¿ƒæƒ³äº‹æˆï¼Œæ¢¦æƒ³æˆçœŸï¼",
            "è´¢æºå¹¿è¿›ï¼Œæ­¥æ­¥é«˜å‡ï¼",
            "èº«ä½“å¥åº·ï¼Œç¬‘å£å¸¸å¼€ï¼",
            "äº‹ä¸šæœ‰æˆï¼Œå‰ç¨‹ä¼¼é”¦ï¼",
            "å­¦ä¸šè¿›æ­¥ï¼Œé‡‘æ¦œé¢˜åï¼",
            "ç¦æ˜Ÿé«˜ç…§ï¼Œå¥½è¿è¿è¿ï¼"
        ];
        
        let themeIndex = 0;
        let themeTimer = null;
        let clickCount = 0;
        let lastClickTime = 0;
        let touchCount = 0;
        let lastTouchTime = 0;
        let personalizationUnlocked = false;
        let userName = '';
        let reverseGravityEnabled = false;
        let keyInput = '';
        let lastFireworkTime = 0;
        let activeTextFireworks = 0;
        const MAX_TEXT_FIREWORKS = 1;
        const textCache = new Map();
        
        // è§¦æ‘¸æ»‘åŠ¨ç›¸å…³å˜é‡
        let touchStartY = 0;
        let touchStartX = 0;
        let touchEndY = 0;
        let touchEndX = 0;
        const SWIPE_THRESHOLD = 80; // æ»‘åŠ¨é˜ˆå€¼
        const SWIPE_HINT_TIMEOUT = 10000; // 10ç§’åéšè—æç¤º
        
        const moonCanvas = document.createElement("canvas");
        const moonCtx = moonCanvas.getContext("2d");
        moonCanvas.width = 480;
        moonCanvas.height = 480;
        
        const moonImage = new Image();
        moonImage.onload = function() {
            moonCtx.clearRect(0, 0, 480, 480);
            moonCtx.drawImage(moonImage, 120, 120, 240, 240);
            
            const gradient = moonCtx.createRadialGradient(240, 240, 120, 240, 240, 240);
            gradient.addColorStop(0, "rgba(255,245,200,0.08)");
            gradient.addColorStop(0.5, "rgba(255,245,200,0.04)");
            gradient.addColorStop(1, "rgba(255,245,200,0)");
            
            moonCtx.fillStyle = gradient;
            moonCtx.beginPath();
            moonCtx.arc(240, 240, 240, 0, Math.PI * 2);
            moonCtx.fill();
            
            updateMoonPosition();
        };
        
        moonImage.onerror = function() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 240;
            tempCanvas.height = 240;
            
            tempCtx.fillStyle = '#f5f3ce';
            tempCtx.beginPath();
            tempCtx.arc(120, 120, 100, 0, Math.PI * 2);
            tempCtx.fill();
            
            moonCtx.clearRect(0, 0, 480, 480);
            moonCtx.drawImage(tempCanvas, 120, 120, 240, 240);
            
            const gradient = moonCtx.createRadialGradient(240, 240, 120, 240, 240, 240);
            gradient.addColorStop(0, "rgba(255,245,200,0.08)");
            gradient.addColorStop(0.5, "rgba(255,245,200,0.04)");
            gradient.addColorStop(1, "rgba(255,245,200,0)");
            
            moonCtx.fillStyle = gradient;
            moonCtx.beginPath();
            moonCtx.arc(240, 240, 240, 0, Math.PI * 2);
            moonCtx.fill();
            
            updateMoonPosition();
        };
        
        moonImage.src = "img/moon.png";
        
        function updateMoonPosition() {
            const moonContainer = document.getElementById('moon-container');
            if (!moonContainer) return;
            
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            const totalMinutes = hours * 60 + minutes;
            const hourPercent = totalMinutes / (24 * 60);
            
            const x = window.innerWidth - 260;
            const y = 100 + Math.sin(hourPercent * Math.PI * 2) * 150;
            
            moonContainer.style.left = `${x}px`;
            moonContainer.style.top = `${y}px`;
        }
        
        class Star {
            constructor() {
                this.x = Math.random() * window.innerWidth;
                this.y = Math.random() * window.innerHeight;
                this.r = Math.random() * 1.2;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.fill();
            }
        }
        
        for (let i = 0; i < 120; i++) stars.push(new Star());
        
        class Boom {
            constructor(tx, ty, shape = null) {
                this.x = rand(window.innerWidth * 0.3, window.innerWidth * 0.7);
                this.y = window.innerHeight;
                this.tx = tx;
                this.ty = ty;
                this.dead = false;
                this.frags = [];
                this.shape = shape;
                this.color = this.getRandomColor();
                this.trail = [];
                this.trailLength = 8;
            }
            
            getRandomColor() {
                const theme = themes[themeIndex];
                return theme.colors[Math.floor(Math.random() * theme.colors.length)];
            }
            
            move() {
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                this.x += dx * 0.05;
                this.y += dy * 0.05;
                
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${0.2 + alpha * 0.3})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 2;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                ctx.fillStyle = "#fff";
                ctx.fill();
                
                if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                    this.explode();
                    this.dead = true;
                }
            }
            
            explode() {
                if (this.shape) {
                    this.createTextBoom();
                    return;
                }
                
                const num = Math.floor(rand(80, 150));
                for (let i = 0; i < num; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = rand(20, 160);
                    this.frags.push(
                        new Frag(
                            this.x, this.y,
                            this.x + Math.cos(angle) * r,
                            this.y + Math.sin(angle) * r,
                            this.color
                        )
                    );
                }
                
                if (Math.random() > 0.7) {
                    setTimeout(() => {
                        bigbooms.push(
                            new Boom(
                                this.x + rand(-120, 120),
                                this.y + rand(-100, 100)
                            )
                        );
                    }, 300);
                }
            }
            
            createTextBoom() {
                if (activeTextFireworks >= MAX_TEXT_FIREWORKS) {
                    this.createNormalBoom();
                    return;
                }
                
                activeTextFireworks++;
                const text = this.shape.textContent;
                const particles = this.getCachedTextParticles(text, this.color);
                
                const maxParticles = Math.min(particles.length, 200);
                for (let i = 0; i < maxParticles; i++) {
                    const p = particles[i];
                    this.frags.push(new Frag(
                        this.x, this.y,
                        this.x + p.dx,
                        this.y + p.dy,
                        this.color
                    ));
                }
                
                setTimeout(() => {
                    activeTextFireworks--;
                }, 3000);
            }
            
            createNormalBoom() {
                const num = Math.floor(rand(80, 150));
                for (let i = 0; i < num; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = rand(20, 160);
                    this.frags.push(
                        new Frag(
                            this.x, this.y,
                            this.x + Math.cos(angle) * r,
                            this.y + Math.sin(angle) * r,
                            this.color
                        )
                    );
                }
            }
            
            getCachedTextParticles(text, color) {
                const cacheKey = `${text}-${color}`;
                if (textCache.has(cacheKey)) {
                    return textCache.get(cacheKey);
                }
                
                const offCanvas = document.createElement("canvas");
                offCanvas.width = 600;
                offCanvas.height = 300;
                const offCtx = offCanvas.getContext("2d");
                
                offCtx.font = "bold 120px 'Microsoft YaHei', 'SimHei', sans-serif";
                offCtx.textAlign = "center";
                offCtx.textBaseline = "middle";
                offCtx.fillStyle = "#fff";
                offCtx.fillText(text, offCanvas.width / 2, offCanvas.height / 2);
                
                const imgData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                const particles = [];
                
                for (let x = 0; x < imgData.width; x += 12) {
                    for (let y = 0; y < imgData.height; y += 12) {
                        const i = (y * imgData.width + x) * 4;
                        if (imgData.data[i + 3] > 150) {
                            particles.push({
                                dx: (x - offCanvas.width/2) * 1.2,
                                dy: (y - offCanvas.height/2) * 1.2
                            });
                        }
                    }
                }
                
                textCache.set(cacheKey, particles);
                return particles;
            }
        }
        
        class Frag {
            constructor(x, y, tx, ty, color) {
                this.x = x;
                this.y = y;
                this.tx = tx;
                this.ty = ty;
                this.vy = 0;
                this.dead = false;
                this.color = color;
                this.trail = [];
                this.trailLength = 5;
            }
            
            move() {
                this.vy += 0.1;
                this.ty += this.vy;
                
                this.x += (this.tx - this.x) * 0.08;
                this.y += (this.ty - this.y) * 0.08;
                
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length * 0.5;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 1;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                if (this.y > window.innerHeight) this.dead = true;
            }
        }
        
        function animate(t) {
            ctx.fillStyle = "rgba(0,5,24,0.2)";
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
            
            stars.forEach(s => s.draw());
            
            const moonContainer = document.getElementById('moon-container');
            if (moonCanvas && moonContainer) {
                const x = parseInt(moonContainer.style.left) || window.innerWidth - 260;
                const y = parseInt(moonContainer.style.top) || 100;
                ctx.drawImage(moonCanvas, x, y, 240, 240);
            }
            
            if (t - lastFireworkTime > 800) {
                if (Math.random() > 0.3) {
                    bigbooms.push(
                        new Boom(
                            rand(120, window.innerWidth - 120),
                            rand(120, window.innerHeight * 0.4)
                        )
                    );
                } else {
                    bigbooms.push(
                        new Boom(
                            window.innerWidth / 2,
                            window.innerHeight * 0.35,
                            shapes[Math.floor(Math.random() * shapes.length)]
                        )
                    );
                }
                lastFireworkTime = t;
            }
            
            for (let i = bigbooms.length - 1; i >= 0; i--) {
                const b = bigbooms[i];
                if (!b.dead) {
                    b.move();
                } else {
                    for (let j = b.frags.length - 1; j >= 0; j--) {
                        const f = b.frags[j];
                        f.move();
                        if (f.dead) {
                            b.frags.splice(j, 1);
                        }
                    }
                    
                    if (b.frags.length === 0) {
                        bigbooms.splice(i, 1);
                    }
                }
            }
            
            raf(animate);
        }
        
        function startThemeRotation() {
            if (themeTimer) clearInterval(themeTimer);
            themeTimer = setInterval(() => {
                themeIndex = (themeIndex + 1) % themes.length;
                applyTheme(themes[themeIndex]);
            }, 10000);
        }
        
        function applyTheme(theme) {
            document.getElementById('theme-indicator').textContent = `ä¸»é¢˜: ${theme.name}`;
        }
        
        function switchTheme(index) {
            themeIndex = index;
            applyTheme(themes[themeIndex]);
        }
        
        function setupEventListeners() {
            // PCç«¯ï¼šä¿ç•™ä¸‰å‡»è§¦å‘ä¸ªæ€§åŒ–æ¨¡æ€æ¡†
            canvas.addEventListener("click", handleCanvasClick);
            
            // ç§»åŠ¨ç«¯ï¼šå‘ä¸Šæ»‘åŠ¨è§¦å‘ä¸ªæ€§åŒ–æ¨¡æ€æ¡†
            canvas.addEventListener("touchstart", handleTouchStart, { passive: true });
            canvas.addEventListener("touchend", handleTouchEnd, { passive: true });
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener("keydown", handleKeyDown);
            
            // æœˆäº®ç‚¹å‡»äº‹ä»¶
            document.getElementById('moon-container').addEventListener('click', showMoonBlessing);
            
            // ä¸ªæ€§åŒ–åŠŸèƒ½
            document.getElementById('submit-name').addEventListener('click', saveUserName);
            document.getElementById('reverse-gravity').addEventListener('click', toggleReverseGravity);
            document.getElementById('lucky-number').addEventListener('click', showLuckyNumber);
            
            // æ‰‹åŠ¿äº‹ä»¶
            setupGestureEvents();
            
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // 10ç§’åéšè—æ»‘åŠ¨æç¤º
            setTimeout(() => {
                const swipeHint = document.getElementById('swipe-hint');
                if (swipeHint) {
                    swipeHint.style.display = 'none';
                }
            }, SWIPE_HINT_TIMEOUT);
        }
        
        function handleCanvasClick(e) {
            const currentTime = Date.now();
            
            // æ£€æŸ¥è¿ç»­ç‚¹å‡» - ä»…PCç«¯ä¿ç•™
            const clickInterval = 1000;
            if (currentTime - lastClickTime < clickInterval) {
                clickCount++;
            } else {
                clickCount = 1;
            }
            lastClickTime = currentTime;
            
            // è¿ç»­ä¸‰æ¬¡ç‚¹å‡»è§¦å‘ä¸ªæ€§åŒ– - ä»…PCç«¯
            if (clickCount >= 3 && !personalizationUnlocked) {
                showPersonalizationModal();
                clickCount = 0;
            }
            
            // å‘å°„çƒŸèŠ±
            bigbooms.push(new Boom(e.clientX, e.clientY));
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
            
            const currentTime = Date.now();
            if (currentTime - lastTouchTime < 1000) {
                touchCount++;
            } else {
                touchCount = 1;
            }
            lastTouchTime = currentTime;
            
            // è¿ç»­10æ¬¡è§¦æ‘¸è§£é”éœ“è™¹ä¸»é¢˜
            if (touchCount >= 10) {
                switchTheme(2);
                showToast('è¿ç»­è§¦æ‘¸10æ¬¡ï¼Œè§£é”éœ“è™¹ä¸»é¢˜ï¼');
                touchCount = 0;
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            
            if (e.changedTouches.length === 1) {
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                
                // æ£€æµ‹å‘ä¸Šæ»‘åŠ¨
                checkSwipeGesture();
                
                // å‘å°„çƒŸèŠ±
                bigbooms.push(new Boom(touchEndX, touchEndY));
            }
        }
        
        function checkSwipeGesture() {
            const deltaY = touchStartY - touchEndY; // å‘ä¸Šæ»‘åŠ¨ä¸ºæ­£
            const deltaX = Math.abs(touchStartX - touchEndX);
            
            // æ£€æµ‹å‘ä¸Šæ»‘åŠ¨ï¼šå‚ç›´ç§»åŠ¨è¶³å¤Ÿå¤§ï¼Œæ°´å¹³ç§»åŠ¨è¾ƒå°
            if (deltaY > SWIPE_THRESHOLD && deltaX < SWIPE_THRESHOLD * 0.5) {
                if (!personalizationUnlocked) {
                    showPersonalizationModal();
                    showToast('â¬†ï¸ å‘ä¸Šæ»‘åŠ¨è§¦å‘ä¸ªæ€§åŒ–è®¾ç½®');
                    
                    // éšè—æ»‘åŠ¨æç¤º
                    const swipeHint = document.getElementById('swipe-hint');
                    if (swipeHint) {
                        swipeHint.style.display = 'none';
                    }
                }
            }
        }
        
        function isTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }
        
        function handleKeyDown(e) {
            keyInput += e.key;
            
            if (keyInput.includes('2026')) {
                switchTheme(4);
                showToast('è¾“å…¥2026ï¼Œè§£é”é¸¿è¿ä¸»é¢˜ï¼');
                keyInput = '';
            }
            
            if (keyInput.length > 10) {
                keyInput = keyInput.slice(-10);
            }
        }
        
        function showPersonalizationModal() {
            const modal = document.getElementById('personalization-modal');
            modal.style.display = 'block';
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('name-input').focus();
            }, 100);
        }
        
        function parseURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const blessParam = urlParams.get('bless');
            
            if (blessParam) {
                showBlessing(decodeURIComponent(blessParam));
            }
        }
        
        function showBlessing(text) {
            const blessingElement = document.getElementById('blessing-text');
            blessingElement.textContent = text;
            blessingElement.style.opacity = '1';
            
            setTimeout(() => {
                blessingElement.style.opacity = '0';
            }, 5000);
        }
        
        function showMoonBlessing() {
            const randomBlessing = blessings[Math.floor(Math.random() * blessings.length)];
            showBlessing(randomBlessing);
            showToast('ğŸŒ™ ç¥ä½ ï¼š' + randomBlessing);
        }
        
        function saveUserName() {
            const nameInput = document.getElementById('name-input');
            userName = nameInput.value.trim();
            
            if (userName) {
                personalizationUnlocked = true;
                document.getElementById('personalization-modal').style.display = 'none';
                document.getElementById('special-effects').style.display = 'block';
                showToast(`ğŸ‰ æ¬¢è¿ ${userName}ï¼Œä¸ªæ€§åŒ–åŠŸèƒ½å·²è§£é”ï¼`);
                
                createPersonalizedFirework();
            } else {
                showToast('è¯·è¾“å…¥æ‚¨çš„åå­—');
            }
        }
        
        function createPersonalizedFirework() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;
            
            setTimeout(() => {
                const nameBoom = new Boom(centerX, centerY);
                nameBoom.explode = function() {
                    const particles = this.getCachedTextParticles(userName, '#ffd700');
                    
                    const maxParticles = Math.min(particles.length, 200);
                    for (let i = 0; i < maxParticles; i++) {
                        const p = particles[i];
                        this.frags.push(new Frag(
                            this.x, this.y,
                            this.x + p.dx,
                            this.y + p.dy,
                            '#ffd700'
                        ));
                    }
                };
                bigbooms.push(nameBoom);
            }, 1000);
        }
        
        function toggleReverseGravity() {
            reverseGravityEnabled = !reverseGravityEnabled;
            
            Frag.prototype.move = function() {
                if (reverseGravityEnabled) {
                    this.vy -= 0.18;
                } else {
                    this.vy += 0.18;
                }
                this.ty += this.vy;
                
                this.x += (this.tx - this.x) * 0.08;
                this.y += (this.ty - this.y) * 0.08;
                
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.trailLength) {
                    this.trail.shift();
                }
                
                if (this.trail.length > 1) {
                    for (let i = 0; i < this.trail.length - 1; i++) {
                        const point1 = this.trail[i];
                        const point2 = this.trail[i + 1];
                        const alpha = i / this.trail.length * 0.5;
                        
                        ctx.strokeStyle = this.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
                        ctx.lineWidth = 1;
                        ctx.lineCap = 'round';
                        ctx.beginPath();
                        ctx.moveTo(point1.x, point1.y);
                        ctx.lineTo(point2.x, point2.y);
                        ctx.stroke();
                    }
                }
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, 1.5, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                if (reverseGravityEnabled) {
                    if (this.y < 0) this.dead = true;
                } else {
                    if (this.y > window.innerHeight) this.dead = true;
                }
            };
            
            showToast(reverseGravityEnabled ? 'ğŸˆ åé‡åŠ›çƒŸèŠ±å·²å¼€å¯' : 'â¬‡ï¸ æ¢å¤æ­£å¸¸é‡åŠ›');
        }
        
        function showLuckyNumber() {
            const luckyNumber = Math.floor(Math.random() * 100) + 1;
            showToast(`ğŸ° ${userName}çš„å¹¸è¿æ•°å­—æ˜¯ï¼š${luckyNumber}`);
            
            const numberBoom = new Boom(window.innerWidth / 2, window.innerHeight / 2);
            numberBoom.explode = function() {
                for (let i = 0; i < luckyNumber; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 100 + 50;
                    
                    this.frags.push(new Frag(
                        this.x, this.y,
                        this.x + Math.cos(angle) * distance,
                        this.y + Math.sin(angle) * distance,
                        '#00ff00'
                    ));
                }
            };
            bigbooms.push(numberBoom);
        }
        
        function setupGestureEvents() {
            canvas.addEventListener('touchend', (e) => {
                if (e.touches.length === 0) {
                    const now = Date.now();
                    if (now - lastTouchTime < 300) {
                        switchTheme((themeIndex + 1) % themes.length);
                    }
                }
            });
            
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 3) {
                    const randomBlessing = blessings[Math.floor(Math.random() * blessings.length)];
                    showBlessing(randomBlessing);
                    showToast('ä¸‰æŒ‡æ‰‹åŠ¿ï¼š' + randomBlessing);
                }
            });
        }
        
        function checkMidnight() {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() < 1) {
                switchTheme(1);
                showToast('ğŸ† å‡Œæ™¨0ç‚¹ï¼Œè‡ªåŠ¨å¯ç”¨é‡‘è‰²ä¸»é¢˜ï¼');
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function init() {
            setupEventListeners();
            parseURLParams();
            checkMidnight();
            startThemeRotation();
            raf(animate);
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
